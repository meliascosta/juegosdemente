<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<html>
<head>
<title>Memory</title>
<meta http-equiv="Content-Type" content="text-html; charset=utf-8"> 
<!--<link rel="stylesheet" type="text/css" href="style.css" /> !-->
<style type="text/css">
body {
	background: url('./res/images/fondoS.jpg') repeat;
	margin: 0px;
	padding: 0px;
}
a{
	color: white;
	text-decoration:none;
}
img{
	position: absolute;
	top:0;
	left:0;
}
div.boton{
	position: absolute;
	top: 0;
	right: 0;
	text-align:center;
	z-index:5;
	font-weight:bold;
	background-color: #5A8EC6;
	color: white;
	cursor:pointer;
	cursor:hand;
}
div.boton:hover {
     background-color: red;
}
.ficha{
	left:0;
	top:0;
	width: 100%;
	margin-left: auto;
	margin-top: auto;
	height: 100%;
	background-color: transparent;
	position: absolute;
}
.imgficha{
	
	width: 100%;
}
.places{
	width: 2em;
	height: 2em;
	position: absolute;
	background-color: #777777;
	color: white;
	font-size: 50px;
	text-align: center;
	border: double;	
}

.grid{
	position: absolute;
	left: 50%;
	top: 10%;
	margin-left: -400px;
}

</style>
{{ js_includes }}
<script type="text/javascript" src="./res/soundmanager2-nodebug-jsmin.js"></script>
<script type="text/javascript" src="./res/checkpoint.js"></script>
<script type="text/javascript" src="./res/highscore.js"></script>
<!--<script type='text/javascript' src='http://getfirebug.com/releases/lite/1.2/firebug-lite-compressed.js'></script>-->
<script type="text/javascript">

String.prototype.repeat = function( num ) // Extend the string type to include a repeat method
{
    return new Array( num + 1 ).join( this );
}

 if(!Array.indexOf){    // Include IndexOf in Explorer that doesn't have it
      Array.prototype.indexOf = function(obj){
          for(var i=0; i<this.length; i++){
              if(this[i]==obj){
                  return i;
              }
          }
          return -1;
      }
  }


function Trial($container, on_good, on_bad,on_win_trial){
	
	var on_good = on_good,
		on_bad = on_bad,
		on_win_trial = on_win_trial,
		$cards = [],
		$container = $container,
		positions = [],
		idx = [],
		card_types = [],
		clicked = [];
	
	function set_board(){
	//SET THE CARDS AND BOARD;	
	for (i=0;i<positions.length;i++){
		$($container).append("<div id=\"place"+ i +"\" class=\"places\" style=\"top: "+positions[i][1]+"%; left: "+positions[i][0]+"%; \">X</div>");
		idx[i] = i;
	}
	for(i=0;i<card_types.length;i++){
		$($container).append("<div id=\"tarj"+ i +"\" class=\"ficha\">"+ "<img class=imgficha src=\"#\">".repeat(card_types[0].length) + " </div>");
		
		$("#tarj"+i+"> img").each(function(j){
			if (card_types[i][j]==null){
				$(this).remove()
				console.log('removed ',i)
			}else{
				$(this).attr("src","./res/images/" + card_types[i][j] + ".png");
			}
		});
		$("#tarj"+i).bind("click",on_click);
		$("#place" +i).append($("#tarj"+i));
					

	}
	$cards = $("div.ficha");
	// END SET
	}
		
	function shuffle(){
		for (i=idx.length+2;i>1;i--){
			randN = Math.floor(Math.random()*idx.length);
			temp = idx[randN];
			idx[randN] = idx[idx.length-1];
			idx[idx.length-1] = temp;
		}
		for (i=0;i<$cards.length;i++){
			$("#place"+idx[i]).append($cards[i]);
			$($cards[i]).fadeIn(700);

		}
		$($cards).bind("click",on_click);
	}
	
	function on_click(){
		numTarj = $(this).attr("id").match(/\d+/);
		$($cards).unbind("click");
		if (clicked.indexOf(this) == -1){
			on_good(card_types[parseInt(numTarj[0])]);
			clicked.push(this);
			if (clicked.length >= card_types.length){
				on_win_trial();
				clicked = [];
				return;
			}
		}else{
			clicked = [];
			on_bad(card_types[parseInt(numTarj[0])]);
			//alert("perdiste");
			return;
		}
		$(this).fadeOut(500,shuffle);
		$($cards).not(this).fadeOut('fast');
	}
	
	this.newtrial = function(pos, c_types){
		$($container +">div").fadeOut('fast',function(){$($cards).remove();	$("div.places").remove();});
		positions = pos.slice(0);
		card_types = c_types.slice(0);
		setTimeout(set_board,3000);
	}
	
	this.end_trial = function(){
		$($container +">div").fadeOut('fast',function(){$($cards).remove();	$("div.places").remove();});
	}

}



	
$(function(){
	var	$game_container = "#game-container";
	
	var		mouseX = [],
			mouseY = [],
			t = [],
			levelN = 0,
			orderN=0;
			tries = 0,
			score = 0,
			tempD = new Date(),
			logger = $.games.new_play(),
			level = $.games.get_gamefile("memory_gamefile0.txt");
			
	var check = new Checkpoint(level.Checkpoints,on_end,on_check);
	var trial = new Trial($game_container,on_good,on_bad,on_win_trial); 
	logger.log("GAME_STARTED", {"time": tempD.getTime()});
		

		
			
		$().mousemove(function(e){
			tempD = new Date();
			mouseX.push(e.pageX);
			mouseY.push(e.pageY);
			t.push(tempD.getTime())
		});
		
		
		// GAME FLOW
		function new_game(){
			check.displaytext("Se largaaaaaa....")
			check.set_at(0);
			trial.newtrial(level.Levels[0].tries[0][0].Positions,level.Levels[0].tries[0][0].Card_types); // Set the first trial
		}
		var scoreTable = new Highscore(new_game);
		
		function topscore(){
			$.games.set_score(score);
			scoreTable.showTable(score)
			trial.end_trial();
		}
		
		function on_good(ficha){
			soundManager.play('bien');
			logger.log("click", {"mouseX": mouseX, "mouseY": mouseY, "t":t , "good": 1, "rtime": t[t.length-1], "level": levelN ,"order": orderN,"tries":tries, "ficha": ficha});
		}
		
		function on_bad(ficha){
			score = score - Math.floor(level.Levels[levelN].num_tarj/3);
			tries++;
			if (tries > level.Levels[levelN].num_tries){
				tries = 0;
			}
			soundManager.play('mal');
			logger.log("click", {"mouseX": mouseX, "mouseY": mouseY, "t":t , "good": 0, "rtime": t[t.length-1], "level": levelN ,"order": orderN,"tries": tries, "ficha": ficha});
			if (tries==2){
				tries =0;
				orderN = 0;
				score = score - 3*Math.floor(level.Levels[levelN].num_tarj/3);
				check.displaytext("Oops! te caiste.");
				check.fallback();
			}else{
			check.displaytext("Uh! Proba de nuevo...");
			}
			trial.newtrial(level.Levels[levelN].tries[tries][orderN].Positions,level.Levels[levelN].tries[tries][orderN].Card_types);
		}
		

		function on_check(){
			tries = 0;
			soundManager.play('check');
		}

		function on_end(){
			logger.log("end_trial",{});
			logger.log("end_game",{});
			check.displaytext("el fin!!");
			levelN = 0;
			orderN=0;
			tries = 0;
			$.games.set_score(score);
			setTimeout(function(){
				check.set_at(0);
				trial.newtrial(level.Levels[0].tries[0][0].Positions,level.Levels[0].tries[0][0].Card_types); // Set the first trial
			},1500)
		}
		function on_win_trial(){
			score = score + level.Levels[levelN].num_tarj;
			if (levelN>=level.levels_num){return}
			orderN++;
			if (orderN==level.Levels[levelN].orders){
			levelN++;
			orderN = 0;
			tries = 0;
			}
			console.log("level:",levelN,"order:",orderN,"tries:",tries);
			check.step();
			check.displaytext("Bien! A ver proba con este...");
			setTimeout(function(){
			trial.newtrial(level.Levels[levelN].tries[tries][orderN].Positions,level.Levels[levelN].tries[tries][orderN].Card_types);
			},1200);
		}
		
		new_game();
		$("#salir").bind("click",topscore);
		soundManager.debugMode = false;
		soundManager.url = './res/';
		soundManager.onload = function() {
		  soundManager.createSound('check','./res/sounds/checkpoint.mp3');
		  soundManager.createSound('bien','./res/sounds/click_bien.mp3');
		  soundManager.createSound('mal','./res/sounds/click_mal.mp3');
		};

})


</script>
</head>
<body>
<div id="salir" class="boton">SALIR</div>
<div id="game-container">
</div>
</body>
</html>
