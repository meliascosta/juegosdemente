<html>
<head>
<title>Grand Prix</title>

{{ js_includes }}
<script type="text/javascript" src="./res/jquery.svg.package-1.3.2/jquery.svganim.js"></script>
<script type="text/javascript" src="./res/jquery.svg.package-1.3.2/jquery.svg.js"></script>
<script type="text/javascript" src="./res/soundmanager2.js"></script>
<script type="text/javascript" src="./res/checkpoint.js"></script>
<script type="text/javascript" src="./res/highscore.js"></script>


<script type="text/javascript">
	
	Array.prototype.sum = function(){  // add the method to add array elements
	for(var i=0,sum=0;i<this.length;sum+=this[i++]);
	return sum;
	}

   $(function(){ 
   
   	var trackImg = [],
	CWIDTH=600,
	CHEIGHT=450,
	xpos = new Array(),
	ypos = new Array(),
	tmax = 15,
	logger = $.games.new_play(),
	scoreTable = new Highscore(resume),
	score = 0,
	errores = 0,
	en_pista= new Array(),
	time = new Array(),
	clock = 0,
	startFlag=-1,
	t = new Date(),
	pixels = new Array(CWIDTH*CHEIGHT*4),
	ctx = $("#gameArea").get(0).getContext('2d'),
	pPaso = 0,
	check = new Checkpoint([5, 10, 15, 20, 25],on_end,on_check),  
    temp = $("#temp").get(0).getContext('2d');
	temp.translate(100,100);
	temp.save(); 
   	for (i=0;i<=4;i++){
		trackImg[i]= new Image();
		trackImg[i].src = './res/images/'+i+'.jpg';
	} //
	var img = new Image();
	img.src = './res/images/Pasto.png';
	img.onload = function(){
	   generate_track([0,1,2,3],[1,2,3,4])
	   
    }
	
	//Drawing functions	
	
	function generate_track(interior,exterior){
		var new_data=0;
		ctx.drawImage(img,0,0);
		temp.restore();
		// dibujo exterior
		ctx.globalCompositeOperation = 'lighter';
		for (c = 0; c < 4; c++) {
			temp.drawImage(trackImg[exterior[c]], -100, -100);
			ctx.drawImage($("#temp").get(0), 175 + 200 * Math.floor(c / 2), 25 + Math.round((c % 3)/1.5) * 200);
			temp.rotate(-Math.PI *90/180);
		}
		temp.restore();
		// dibujo interior
		temp.transform(0,-1,-1,0,0,0);
		for (c = 0; c < 4; c++) {
			temp.drawImage(trackImg[interior[c]], -100, -100);
			ctx.drawImage($("#temp").get(0), 175 + 200 * Math.floor(c / 2), 25 + Math.round((c % 3)/1.5) * 200);
			temp.rotate(Math.PI *90/180);
		}
		x = ctx.getImageData(0,0,600,450);
		pixels= x.data;
		ctx.globalCompositeOperation = 'source-over';  
		ctx.fillStyle = "#0abcdf"
		ctx.fillRect(170,220,40,20);
	}
	
	// Event handling functions
	function on_mousemove_boxes(e){
		if (startFlag==0){
			clearTimeout(c1);
			clearTimeout(c2);
			$('#puntos').text('Corredores a la largada...')
			check.displaytext('Epa te zarpaste, empeza de nuevo');
			comienzo();
		}
		if (clock!=0)
			clearTimeout(clock);
		if ((e.layerX>165 &e.layerX<180 &e.layerY>217 &e.layerY<228)|(e.layerX<5&e.layerY<5)){
			$("#llegada").css('background-color','yellow');
			clock = setTimeout(largada,2000);
		}
		else{
			$("#llegada").css('background-color','blue');
		}
			
	}
	function on_mousemove_carrera(e){
		t = new Date();
		time.push(t.getTime());
		xpos.push(e.layerX);
		ypos.push(e.layerX);
		en_pista.push(pixels[CWIDTH*(e.layerY+10)*4+(e.layerX+20)*4]==255);
		
		//puntos de paso
		if (e.layerX>155 &e.layerX<190 &e.layerY>207 &e.layerY<240)
			pPaso = pPaso|1
		if (e.layerX>340 &e.layerX<410 &e.layerY>22 &e.layerY<80)
			pPaso = pPaso|2
		if (e.layerX>520 &e.layerX<590 &e.layerY>200 &e.layerY<260)
			pPaso = pPaso|4
		if (e.layerX>350 &e.layerX<410 &e.layerY>380 &e.layerY<440)
			pPaso = pPaso|8
			
		if (en_pista[en_pista.length-1]){
			$("#game-container").css('cursor','url(./res/images/auto2.gif),auto');
		}else{
			$("#game-container").css('cursor','url(./res/images/autofuera2.gif),auto');
		}
		if (e.layerX>165 &e.layerX<180 &e.layerY>217 &e.layerY<230&pPaso ==15){
			$("#bandera").slideDown(250);
			pPaso = 0;
			setTimeout(show_puntos,1000);
		}
		
	}


	//gameflow functions
	
	function largada(){
		var ims = $("#semaforo > img");
		$(ims[1]).hide()
		$(ims[2]).hide()
		$("#semaforo").show();
		$("#puntos").text('En sus marcas.')
		c1 = setTimeout(function(){$(ims[1]).show();$("#puntos").text('Listos...')},2000);
		c2 = setTimeout(function(){
			$(ims[2]).show();
			$("#llegada").hide();
			$("#gameArea").css('visibility','visible');
			$("#game-container").unbind('mousemove',on_mousemove_boxes);
			$("#game-container").bind('mousemove',on_mousemove_carrera);
			$("#puntos").hide();
			startFlag = 1;
			},4000);
		startFlag=0;	
	}
	
	function comienzo(){
		time=[];
		xpos=[];
		ypos=[];
		en_pista = [];
		startFlag=-1;
		$("#llegada").css('background-color','blue');
		$("#game-container").unbind('mousemove',on_mousemove_carrera);
		$("#game-container").bind('mousemove',on_mousemove_boxes);	
	}
	function show_puntos(){
		$("#game-container").unbind('mousemove',on_mousemove_carrera);
		$("#semaforo").hide();
		$("#gameArea").css('visibility','hidden');
		var timeTot = Math.round(time[time.length-1]-time[0])/1000;
		var penalizacion = 0;
		for (i=0;i<xpos.length;i++){
			if (!en_pista[i]){
				penalizacion+= Math.round(Math.abs(xpos[i]-xpos[i-1]) + Math.abs(ypos[i]-ypos[i-1]))/10
			}
		}
		$("#puntos").text('Tu tiempo: '+timeTot+ ' s + '+ penalizacion.toFixed(3) + 's extra = '+ (timeTot+penalizacion).toFixed(3)+ ' s' );
		$("#puntos").show();
		if (timeTot+penalizacion<tmax){
			check.step();
			score = score + 1 + 0.5*(tmax - timeTot - penalizacion);
		}else{
			errores = errores + 1;
			if (errores >= 3){
				errores = 0;
				score = score - 10;
				check.fallback();
			}
		}
		setTimeout(function(){
			$("#puntos").text('Corredores a la largada...');
			$("#bandera").slideUp(250);
			nueva_pista();
		},5000);
		}
	function nueva_pista(){
		setTimeout(function(){
			$("#tmax").text('Tiempo max: '+ tmax.toFixed(3) + 's')
			$("#llegada").show();
			var interior = new Array(4);
			var exterior = new Array(4);
			for (i =0;i<=4;i++){
				interior[i] = Math.round(Math.random()*4);
				exterior[i] = Math.round(Math.random()*4);
			}
			generate_track(interior,exterior);
			logger.log("newTrack",{"interior":interior, "exterior":exterior})
			comienzo();	
		},1000);
		
	}
	
	function on_end(){}
	
	function resume(){
		scoreTable.hideTable();	
	}
	function on_check(){
		tmax =  tmax - 15/40;
		$.games.set_score(Math.round(score*100),[0,0]);
		scoreTable.showTable(Math.round(score*100))
	}
	
	
	//startUp
	$("#bandera").slideUp();
	nueva_pista()
	
	
       
     
	 
	   
   });
</script>

<link rel="stylesheet" type="text/css" href="style.css" />
</head>


<body>
<div id="game-container" height = "600" width="450"> 
<canvas id="gameArea" width="600" height="450"></canvas>
<div id="semaforo">
<img style="height:100%;left:0;" src="./res/images/semaforo1.png">
<img style="height:100%;left:0;" src="./res/images/semaforo2.png">
<img style="height:100%;left:0;" src="./res/images/semaforo3.png">
</div>
<div id="llegada">largada</div>
<div id="puntos">Corredores a la largada... </div>
<div id="bandera"><img style= "left: 0; width:100%" src='./res/images/bandera.png'></div>
</div>
<div id="tmax">Tiempo max: 15.000 s</div>

<canvas id="temp" width="200" height="200"></canvas>
</body>

</html>

