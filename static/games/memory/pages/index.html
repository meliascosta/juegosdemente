<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<html>
<head>
<title>Memory</title>
<meta http-equiv="Content-Type" content="text-html; charset=utf-8"> 
<!--<link rel="stylesheet" type="text/css" href="style.css" /> !-->
<style type="text/css">
body {
	background: url('./res/images/fondoS0.jpg') repeat;
	margin: 0px;
	overflow:hidden;
	padding: 0px;
}
a{
	color: white;
	text-decoration:none;
}
img{
	position: absolute;
	top:0;
	left:0;
}
div.boton{
	position: absolute;
	top: 15%;
	right:3%;
	-moz-border-radius: 10px;
    -webkit-border-radius: 10px;
    text-align: center;
	padding:10px;
	border:ridge;
	z-index:5;
	font-weight:bold;
	background-color: #5A8EC6;
	color: white;
	cursor:pointer;
	cursor:hand;
}
div.boton:hover {
     background-color: red;
}
.ficha{
	left:5%;
	top:5%;
	width: 90%;
	margin-left: auto;
	margin-top: auto;
	height: 90%;
	background-color: transparent;
	position: absolute;
}
.imgficha{
	
	width: 100%;
}
.places{
	width: 6em;
	height: 6em;
	position: absolute;
	background: #647D0C;
	border: 1em #D8C65F solid;
	-moz-border-radius: .5em;
	-webkit-border-radius: .5em;
}
.grid{
	position: absolute;
	left: 50%;
	top: 10%;
	margin-left: -400px;
}

</style>
{{ js_includes }}
<script type="text/javascript" src="./res/soundmanager2-nodebug-jsmin.js"></script>
<script type="text/javascript" src="./res/checkpoint.js"></script>
<script type="text/javascript" src="./res/highscore.js"></script>
<script type="text/javascript" src="./res/video_player.js"></script>
<!--<script type='text/javascript' src='http://getfirebug.com/releases/lite/1.2/firebug-lite-compressed.js'></script>-->
<script type="text/javascript">

String.prototype.repeat = function( num ) // Extend the string type to include a repeat method
{
    return new Array( num + 1 ).join( this );
}

 if(!Array.indexOf){    // Include IndexOf in Explorer that doesn't have it
      Array.prototype.indexOf = function(obj){
          for(var i=0; i<this.length; i++){
              if(this[i]==obj){
                  return i;
              }
          }
          return -1;
      }
  }


function Trial($container, on_good, on_bad,on_win_trial,on_start,on_appear){
	
	var on_good = on_good,
		on_bad = on_bad,
		on_win_trial = on_win_trial,
		on_start = on_start,
		on_appear = on_appear,
		$cards = [],
		$container = $container,
		positions = [],
		idx = [],
		card_types = [],
		clicked = [];
	
	function set_board(){
	//SET THE CARDS AND BOARD;	
	for (i=0;i<positions.length;i++){
		$($container).append("<div id=\"place"+ i +"\" class=\"places\" style=\"top: "+positions[i][1]+"%; left: "+positions[i][0]+"%; \"></div>");
		idx[i] = i;
	}
	for(i=0;i<card_types.length;i++){
		$($container).append("<div id=\"tarj"+ i +"\" class=\"ficha\">"+ "<img class=imgficha src=\"#\">".repeat(card_types[0].length) + " </div>");
		
		$("#tarj"+i+"> img").each(function(j){
			if (card_types[i][j]==null){
				$(this).remove()
				//console.log('removed ',i)
			}else{
				$(this).attr("src","./res/images/" + card_types[i][j] + ".png");
			}
		});
		$("#tarj"+i).bind("click",on_click);
		$("#place" +i).append($("#tarj"+i));
					

	}
	$cards = $("div.ficha");
	on_start();
	// END SET
	}
		
	function shuffle(){
		for (i=idx.length+2;i>1;i--){
			randN = Math.floor(Math.random()*idx.length);
			temp = idx[randN];
			idx[randN] = idx[idx.length-1];
			idx[idx.length-1] = temp;
		}
		for (i=0;i<$cards.length;i++){
			$("#place"+idx[i]).append($cards[i]);
			$($cards[i]).fadeIn(1500);

		}
		on_appear();
		$($cards).bind("click",on_click);
	}
	
	function on_click(){
		
		numTarj = $(this).attr("id").match(/\d+/);
		$($cards).unbind("click");
		if (clicked.indexOf(this) == -1){
			on_good(card_types[parseInt(numTarj[0])]);
			clicked.push(this);
			if (clicked.length >= card_types.length){
				on_win_trial();
				clicked = [];
				return;
			}
		}else{
			clicked = [];
			on_bad(card_types[parseInt(numTarj[0])]);
			//alert("perdiste");
			return;
		}
		$(this).fadeOut(500,shuffle);
		$($cards).not(this).fadeOut('fast');
	}
	
	this.newtrial = function(pos, c_types){
		$($container +">div").fadeOut('fast',function(){$($cards).remove();	$("div.places").remove();});
		positions = pos.slice(0);
		card_types = c_types.slice(0);
		setTimeout(set_board,800);
	}
	
	this.end_trial = function(){
		$($container +">div").fadeOut('fast',function(){$($cards).remove();	$("div.places").remove();});
		clicked = [];
	}

}



	
$(function(){
	var	$game_container = "#game-container";
	
	var		mouseX = [],
			mouseY = [],
			t = [],
			levelN = 0,
			orderN=0;
			tries = 0,
			score = 0,
			END_SCHOOL=0,
			savedSCORE = 0,
			tempD = new Date(),
			logger = $.games.new_play(),
			player = new videoPlayer();
			state = [0,0];
			if ($.games.is_school_player){setTimeout(function(){END_SCHOOL = 1},$.games.school_max_time*1000)}
			if ($.games.is_authenticated){
				state = $.games.state;
				score = $.games.score;
			}
	var gamefileN = state[0];
	var levelN = state[1];
	if ($.games.is_shool_player){
		var level = $.games.get_gamefile("memory_gamefile"+gamefileN+".txt");
	}else{
		var letra = ['','b','c']
		var level = $.games.get_gamefile("memory_gamefile"+gamefileN+letra[Math.floor(Math.random()*3)]+".txt");
	}
	var check = new Checkpoint(level.Checkpoints,on_end,on_check);
	var trial = new Trial($game_container,on_good,on_bad,on_win_trial,on_start,on_appear); 
	logger.log("GAME_STARTED", {"time": tempD.getTime()});
		

		
			
		$().mousemove(function(e){
			tempD = new Date();
			mouseX.push(e.pageX);
			mouseY.push(e.pageY);
			t.push(tempD.getTime())
		});
		
		
		// GAME FLOW
		function new_game(){
			tempD = new Date();
			logger.log("level_started", {"time": tempD.getTime()});
			check.displaytext("Empieza.")
			orderN=0;
			tries = 0;
			check.set_at(levelN);
			trial.newtrial(level.Levels[levelN].tries[0][0].Positions,level.Levels[levelN].tries[0][0].Card_types); // Set the first trial
		}
		
		var scoreTable = new Highscore(new_game);
		
		function topscore(){
			savedSCORE = score;
			$.games.set_score(score,[gamefileN,levelN]);
			scoreTable.showTable(savedSCORE)
		}
		
		function on_good(ficha){
			//player.play();
			soundManager.play('bien');
			tempD = new Date();
			logger.log("click", {"mouseX": mouseX, "mouseY": mouseY, "t":t , "good": 1, "time": tempD.getTime(),  "ficha": ficha});
			mouseX = []; mouseY=[];t=[];
		}
		
		function on_bad(ficha){
			logger.log("end_trial",{"good":0 ,"level": levelN ,"order": orderN,"tries":tries,"time": tempD.getTime()});
			if (END_SCHOOL){
						$.games.set_score(score,[gamefileN, levelN]);
						$.games.school_end_stage();
						check.displaytext('Eso fue todo por hoy...')
						setTimeout(function(){
                        	window.location = $.games.main_site;
                    	}, 3500);
						return
					}
			score = score - Math.floor(level.Levels[levelN].num_tarj/3);
			tries++;
			if (tries > level.Levels[levelN].num_tries){
				tries = 0;
			}
			soundManager.play('mal');
			tempD = new Date();			
			logger.log("click", {"mouseX": mouseX, "mouseY": mouseY, "t":t , "good": 0, "time": tempD.getTime(),  "ficha": ficha});
			mouseX = []; mouseY=[];t=[];
			if (tries==2){
				tries =0;
				orderN = 0;
				score = score - 3*Math.floor(level.Levels[levelN].num_tarj/3);
				check.displaytext("Oops! te caiste.");
				check.fallback();
			}else{
			check.displaytext("Uh! Proba de nuevo...");
			}
			trial.newtrial(level.Levels[levelN].tries[tries][orderN].Positions,level.Levels[levelN].tries[tries][orderN].Card_types);
		}
		
	
		function on_check(){
			tries = 0;
			$.games.set_score(score,[gamefileN,levelN]);
			savedSCORE = score;
			soundManager.play('check');
		}
		
		function on_start(){
			tempD = new Date();	
			logger.log("start_trial", {"time": tempD.getTime(),"cards":level.Levels[levelN].tries[tries][orderN].Card_types,"positions":level.Levels[levelN].tries[tries][orderN].Positions,"to_check": level.Levels[levelN].tries[tries].length-orderN})
		}
		function on_appear(){
			tempD = new Date();	
			logger.log("cards_appear", {"time": tempD.getTime()})
		}
		
		function on_end(){
			tempD = new Date();	
			logger.log("level_ended", {"time": tempD.getTime(),"good":1});
			check.displaytext("¡MUY BIEN! Vamos por más.");
			levelN = 0;
			orderN=0;
			tries = 0;
			if (gamefileN< $.games.gamefile_list.length){
			gamefileN++;
			}
			$.games.set_score(score,[gamefileN,0]);
			$("body").css("background","url('./res/images/fondoS"+gamefileN+".jpg') repeat");
			level = $.games.get_gamefile("memory_gamefile"+gamefileN+".txt");
			setTimeout(function(){
				new_game();
			},1500)
		}
		function on_win_trial(){
			logger.log("end_trial",{"good":1,"level": levelN ,"order": orderN,"tries":tries,"time": tempD.getTime()});
			score = score + level.Levels[levelN].num_tarj;
			orderN++;
			if (orderN==level.Levels[levelN].orders){
			levelN++;
			orderN = 0;
			tries = 0;
			}
			if (levelN>=level.levels_num){return}
			if (END_SCHOOL){
						$.games.set_score(score,[gamefileN, levelN]);
						$.games.school_end_stage();
						check.displaytext('Eso fue todo por hoy...')
						setTimeout(function(){
                        	window.location = $.games.main_site;
                    	}, 3500);
						return
					}
			//console.log("level:",levelN,"order:",orderN,"tries:",tries);
			check.step();
			check.displaytext("Bien! A ver proba con este...");
			setTimeout(function(){
			trial.newtrial(level.Levels[levelN].tries[tries][orderN].Positions,level.Levels[levelN].tries[tries][orderN].Card_types);
			},1200);
		}
		
		$(this).bind("contextmenu", function(e) { // disable right click
                	e.preventDefault();
           	    });
		new_game();
		$("#salir").bind("click",topscore);
		soundManager.debugMode = false;
		soundManager.url = './res/';
		soundManager.onload = function() {
		  soundManager.createSound('check','./res/sounds/checkpoint.mp3');
		  soundManager.createSound('bien','./res/sounds/click_bien.mp3');
		  soundManager.createSound('mal','./res/sounds/click_mal.mp3');
		};

})


</script>
</head>
<body>
<div id="salir" class="boton">PUNTOS</div>
<div id="game-container">
</div>
</body>
</html>
