<html>
<head>
<title>Grand Prix</title>

{{ js_includes }}
<script type="text/javascript" src="./res/jquery.svg.package-1.3.2/jquery.svganim.js"></script>
<script type="text/javascript" src="./res/jquery.svg.package-1.3.2/jquery.svg.js"></script>
<script type="text/javascript" src="./res/soundmanager2.js"></script>
<script type="text/javascript" src="./res/checkpoint.js"></script>
<script type="text/javascript" src="./res/highscore.js"></script>


<script type="text/javascript">
	
	Array.prototype.sum = function(){  // add the method to add array elements
	for(var i=0,sum=0;i<this.length;sum+=this[i++]);
	return sum;
	}

   $(function(){ 
   
   	var trackImg = [],
	CWIDTH=720,
	CHEIGHT=540,
	xpos = new Array(),
	ypos = new Array(),
	tmax = 60,
	logger = $.games.new_play(),
	backsound,
	scoreTable = new Highscore(resume),
	score = 0,
	checknum = 0,
	to_check = 5,
	level = 0,
	errores = 0,
	en_pista= new Array(),
	time = new Array(),
	clock = 0,
    clockwiseFlag= 0,
	startFlag=-1,
	END_SCHOOL = 0,
	t = new Date(),
	pixels = new Array(CWIDTH*CHEIGHT*4),
	ctx = $("#gameArea").get(0).getContext('2d'),
	pPaso = 0,
	check = new Checkpoint([5, 10, 15, 20, 25],on_end,on_check),  
    temp = $("#temp").get(0).getContext('2d');
	temp.translate(110,110);
	temp.save(); 
   	for (i=0;i<=4;i++){
		trackImg[i]= new Image();
		trackImg[i].src = './res/images/'+i+'.jpg';
	} //
	var img = new Image();
	img.src = './res/images/Pasto.png';
	if ($.games.is_school_player){setTimeout(function(){END_SCHOOL = 1},$.games.school_max_time*1000)}
	if ($.games.is_authenticated){
		state = $.games.state;
		level = state[0];
		checknum = state[1];
	}

	  // LOAD SOUNDS
	soundManager.debugMode = false
        soundManager.url = './res/';
        soundManager.debugMode = false;

	soundManager.onload = function() {
		soundManager.createSound('tone1','./res/sounds/tone1.mp3');
		soundManager.createSound('tone2','./res/sounds/tone2.mp3');
		soundManager.createSound('car_start','./res/sounds/car_start.mp3');
		soundManager.createSound('banderin','./res/sounds/banderin.mp3');
		soundManager.createSound('win','./res/sounds/win.mp3');
	        soundManager.createSound('move','./res/sounds/move.mp3');
	        soundManager.createSound('loose','./res/sounds/loose.mp3');
		nueva_pista()
		}

	//Drawing functions	
	
	function generate_track(interior,exterior){
		var LADO = 220,
			PX = 200,
			PY = 75,
			new_data=0;
		ctx.drawImage(img,0,0);
		ctx.globalCompositeOperation = 'lighter';
		
		temp.restore();
		// dibujo exterior
		

		for (c = 0; c < 4; c++) {
			temp.drawImage(trackImg[exterior[c]], -LADO/2, -LADO/2);
			ctx.drawImage($("#temp").get(0), PX + LADO * Math.floor(c / 2),PY + Math.round((c % 3)/1.5) * LADO);
			temp.rotate(-Math.PI *90/180);
		}
		
		temp.restore()
		// dibujo interior
		temp.transform(0,-1,-1,0,0,0);
		for (c = 0; c < 4; c++) {
			temp.drawImage(trackImg[interior[c]], -LADO/2, -LADO/2);
			ctx.drawImage($("#temp").get(0), PX + LADO * Math.floor(c / 2), PY + Math.round((c % 3)/1.5) * LADO);
			temp.rotate(Math.PI *90/180);
		}
		x = ctx.getImageData(0,0,720,540);
		pixels= x.data;
		ctx.globalCompositeOperation = 'source-over';  
		ctx.fillStyle = "#0abcdf"
		ctx.fillRect(190,290,40,20);
	}
	
	// Event handling functions
	function on_mousemove_boxes(e){
		if (startFlag==0){
			clearTimeout(c1);
			clearTimeout(c2);
			$('#puntos').text('Corredores a la largada...')
			$("#semaforo").hide();
			check.displaytext('Epa te moviste, empeza de nuevo');
			soundManager.play('move');
			comienzo();
		}
		if (clock!=0)
			clearTimeout(clock);
		if ((e.layerX>165 &e.layerX<180 &e.layerY>217 &e.layerY<228)|(e.layerX<5&e.layerY<5)){
			$("#llegada").css('background-color','yellow');
			clock = setTimeout(largada,2000);
		}
		else{
			$("#llegada").css('background-color','blue');
		}
			
	}
	function show_paso(i){
		if ((pPaso & i) == 0){
			pPaso = pPaso|i;
			soundManager.play('banderin');
			setTimeout(function(){		
			$("#banderin"+Math.floor(i/2)).show();},500);
		}
	}
	function on_mousemove_carrera(e){
		t = new Date();
		time.push(t.getTime());
		xpos.push(e.layerX);
		ypos.push(e.layerX);
		en_pista.push((pixels[CWIDTH*(e.layerY+10)*4+(e.layerX+20)*4]==255)*1);
		
		//puntos de paso
	    if (e.layerX>370 &e.layerX<470 &e.layerY>73 &e.layerY<130&clockwiseFlag)
			show_paso(1);
	   	if (e.layerX>370 &e.layerX<470 &e.layerY>73 &e.layerY<130& (pPaso&2)>0)
			show_paso(1)
	   	if (e.layerX>580 &e.layerX<640 &e.layerY>280 &e.layerY<320 & pPaso != 0)
			show_paso(2)
		if (e.layerX>370 &e.layerX<470 &e.layerY>470 &e.layerY<530& !clockwiseFlag)
			show_paso(4)
		if (e.layerX>370 &e.layerX<480 &e.layerY>470 &e.layerY<530& (pPaso&2)>0)
			show_paso(4)
		if (en_pista[en_pista.length-1]){
			$("#game-container").css('cursor','url(./res/images/auto2.gif),auto');
		}else{
			$("#game-container").css('cursor','url(./res/images/autofuera2.gif),auto');
		}
		if (e.layerX>170 &e.layerX<210 &e.layerY>270 &e.layerY<310&pPaso ==7){
			$("#bandera").slideDown(250);
			pPaso = 0;
			setTimeout(show_puntos,1000);
		}
		
	}


	//gameflow functions
	
	function largada(){
		var ims = $("#semaforo > img");
		$(ims[1]).hide()
		$(ims[2]).hide()
		$("#semaforo").show();
		$("#puntos").text('En sus marcas.')
		soundManager.play('tone1');
		c1 = setTimeout(function(){$(ims[1]).show();$("#puntos").text('Listos...');soundManager.play('tone1');},2000);
		c2 = setTimeout(function(){
			$(ims[2]).show();
			$("#llegada").hide();
			$("#gameArea").css('visibility','visible');
			soundManager.play('tone2');
			$("#game-container").unbind('mousemove',on_mousemove_boxes);
			$("#game-container").bind('mousemove',on_mousemove_carrera);
			$("#puntos").hide();
			startFlag = 1;
			},4000);
		startFlag=0;	
	}
	
	function comienzo(){
		time=[];
		xpos=[];
		ypos=[];
		en_pista = [];
		startFlag=-1;
		$("#llegada").css('background-color','blue');
		$("#game-container").unbind('mousemove',on_mousemove_carrera);
		$("#game-container").css('cursor','url(./res/images/auto2.gif),auto');
		$("#game-container").bind('mousemove',on_mousemove_boxes);	
	}

	function show_puntos(){
		$("#game-container").unbind('mousemove',on_mousemove_carrera);
		$("#semaforo").hide();
		$("#flecha").hide();
		$("#gameArea").css('visibility','hidden');
		$("[id^=banderin]").hide();
		var timeTot = Math.round(time[time.length-1]-time[0])/1000;
		var penalizacion = 0;
		for (i=1;i<xpos.length;i++){
			if (!en_pista[i]){
				penalizacion+= Math.round(Math.abs(xpos[i]-xpos[i-1]) + Math.abs(ypos[i]-ypos[i-1]))/20
			}
		}
		$("#puntos").text('Tu tiempo: '+timeTot+ ' s + '+ penalizacion.toFixed(3) + 's extra = '+ (timeTot+penalizacion).toFixed(3)+ ' s' );
		$("#puntos").show();
		if (timeTot+penalizacion<tmax){
			check.step();
			to_check--;
			soundManager.play('win');
			score = score + 1 + 0.5*(tmax - timeTot - penalizacion);
		}else{
			soundManager.play('loose');
			errores = errores + 1;
			if (errores >= 3){
				errores = 0;
				score = score - 10;
				check.fallback();
				logger.log('fallBack',{'score':score})
			}
		}
        logger.log("raceEnd",{"xpos":xpos, "ypos":ypos,"time":time,"en_pista":en_pista,"score":score,"tmax":tmax,"timeTot":timeTot, "penalizacion":penalizacion.toFixed(3),"win":(timeTot+penalizacion<tmax)})
		if (END_SCHOOL){
			$.games.set_score(score,[0,0]);
			$.games.school_end_stage();
			check.displaytext('Eso fue todo por hoy...')
			setTimeout(function(){
            	window.location = $.games.main_site;
        	}, 3500);
			return
		}
		setTimeout(function(){
			$("#puntos").text('Corredores a la largada...');
			$("#bandera").slideUp(250);
			nueva_pista();
		},5000);
		}

	function nueva_pista(){
		soundManager.play('car_start');
		setTimeout(function(){
			$("#tmax").text('Tiempo max: '+ tmax.toFixed(3) + 's')
			$("#llegada").show();
			var interior = new Array(4);
			var exterior = new Array(4);
			for (i =0;i<4;i++){
				interior[i] = Math.round(Math.random()*4);
				exterior[i] = Math.round(Math.random()*4);
			}
		        clockwiseFlag = Math.random()>0.5;
			$("#flecha_"+!clockwiseFlag*1).show();
			$("#flecha_"+clockwiseFlag*1).hide();
			$("#flecha").show();
			generate_track(interior,exterior);
			logger.log("newTrack",{"interior":interior, "exterior":exterior,"clockwise" : clockwiseFlag, 'tmax':tmax.toFixed(3),'to_check':to_check,'checknum':checknum,'level':level,'errores':errores})
			comienzo();	
		},1000);
		
	}
	
	function on_end(){
		level++;
		tmax =  tmax - 15/40;
		checknum++; 
		$.games.set_score(Math.round(score*100),[level,checknum]);
		scoreTable.showTable(Math.round(score*100))
		setTimeout(function(){check.set_at(0);},1000);
		check.displaytext('Groso. A ver ahora...')
		$("body").css("background","url('./res/images/fondoS"+level+".jpg') repeat");
	}
	
	function resume(){
		scoreTable.hideTable();	
	}
	function on_check(){
		tmax =  tmax - 15/40;
		checknum++;
		to_check = 5; 
		$.games.set_score(Math.round(score*100),[level,checknum]);
		scoreTable.showTable(Math.round(score*100))
	}
	
	$(this).bind("contextmenu", function(e) { // disable right click
                	e.preventDefault();
           	    });
	//startUp
	$("#bandera").slideUp();
	check.set_at(checknum%5);
	tmax = tmax - 15/40 * checknum;
	$("body").css("background","url('./res/images/fondoS"+level+".jpg') repeat");
	
       
     
	 
	   
   });
</script>

<link rel="stylesheet" type="text/css" href="style.css" />
</head>


<body>
<div id="game-container" height = "600" width="450"> 
<canvas id="gameArea" width="720" height="540"></canvas>
<img id="banderin0" src = "./res/images/banderin.png">
<img id="banderin1" src = "./res/images/banderin.png">
<img id="banderin2" src = "./res/images/banderin.png">
<div id="semaforo">
<img style="height:100%;left:0;" src="./res/images/semaforo1.png">
<img style="height:100%;left:0;" src="./res/images/semaforo2.png">
<img style="height:100%;left:0;" src="./res/images/semaforo3.png">
</div>
<div id="flecha">
<img id = "flecha_0" style="height:100%;left:0;" src="./res/images/flecha_clock.png">
<img id = "flecha_1" style="height:100%;left:0;" src="./res/images/flecha_counter.png">
</div>
<div id="llegada">largada</div>
<div id="puntos">Corredores a la largada... </div>
<div id="bandera"><img style= "left: 0; width:100%" src='./res/images/bandera.png'></div>
</div>
<div id="tmax">Tiempo max: 15.000 s</div>

<canvas id="temp" width="220" height="220"></canvas>
</body>

</html>

